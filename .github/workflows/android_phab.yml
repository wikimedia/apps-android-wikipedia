name: Post to Phabricator

on:
  pull_request:
    types: [opened, closed]

jobs:
  post_to_phab:
    runs-on: ubuntu-latest
    steps:
    - name: Post to Phabricator when pull request is opened or closed
      if: ${{ github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'closed') }}
      env:
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        message="${{ github.actor }} ${{ github.event.action }} ${{ github.event.pull_request._links.html.href }}"
        echo "${message}"
        task=$(echo "${PR_BODY}" | grep "^Bug: T[0-9]*$" | head -1 | awk '{print $2}')
        if [ -n "${task}" ]; then
          curl https://phabricator.wikimedia.org/api/maniphest.edit \
              -d api.token=${{ secrets.PHAB_BOT_API_KEY }} \
              -d transactions[0][type]=comment \
              -d transactions[0][value]="${message}" \
              -d objectIdentifier=${task}
        fi
