name: Android Onboarding Test CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  instrumentation-tests:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    - uses: gradle/gradle-build-action@v3

    - name: Instrumentation Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        script: ./gradlew connectedDevDebugAndroidTest --stacktrace --no-daemon -P android.testInstrumentationRunnerArguments.class=org.wikipedia.tests.OnboardingTest

    - name: Install Allure CLI
      if: ${{ always() }}
      run: |
        npm install -g allure-commandline@latest
        allure --version

    - name: Pull Allure results and generate report
      if: ${{ always() }}
      env:
        CI: true
        GITHUB_ACTIONS: true
      run: |
        chmod +x ./pull-allure-results.sh
        ./pull-allure-results.sh

    - name: Upload test results
      if: ${{ always() }}
      uses: actions/upload-artifact@v6
      with:
        name: onboarding-test-results
        path: |
          allure-results/
          app/build/reports/androidTests/connected/**
        retention-days: 30

    - name: Upload Allure report
      if: ${{ always() }}
      uses: actions/upload-artifact@v6
      with:
        name: allure-report-onboarding
        path: |
          allure-report.tar.gz
          allure-report/
        retention-days: 30

